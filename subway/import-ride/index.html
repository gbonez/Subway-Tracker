<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NYC Subway Route Importer</title>
    <link rel="icon" type="image/x-icon" href="../../forrest.ico">
    <style>
        :root {
            --bg-color: #121212;
            --text-color: #e0e0e0;
            --border-color: #333;
            --highlight-color: #1e1e1e;
            --input-bg: #1e1e1e;
            --input-border: #444;
            --button-bg: #333;
            --button-text: #fff;
            --success-color: #90ee90;
            --warning-color: #ffd700;
            --error-color: #ff6b6b;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: sans-serif;
            margin: 1em;
        }

        .container {
            max-width: 100%;
            padding: 1em;
            box-sizing: border-box;
        }

        .nav-links {
            margin-bottom: 2em;
            display: flex;
            gap: 1em;
            flex-wrap: wrap;
        }

        .nav-links a {
            color: var(--text-color);
            text-decoration: none;
            padding: 0.5em 1em;
            border: 1px solid var(--input-border);
            background-color: var(--input-bg);
            border-radius: 4px;
        }

        .nav-links a:hover {
            background-color: var(--button-bg);
        }

        .nav-links a.active {
            background-color: var(--button-bg);
        }

        input[type="url"] {
            background-color: var(--input-bg);
            color: var(--text-color);
            border: 1px solid var(--input-border);
            margin: 0.5em 0;
            padding: 0.75em;
            font-size: 1rem;
            width: 100%;
            box-sizing: border-box;
            border-radius: 4px;
        }

        button {
            background-color: var(--button-bg);
            color: var(--button-text);
            border: 1px solid var(--input-border);
            cursor: pointer;
            padding: 0.75em 1.5em;
            font-size: 1rem;
            margin: 0.5em 0.5em 0.5em 0;
            border-radius: 4px;
        }

        button:hover {
            background-color: #444;
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .message {
            margin: 1em 0;
            padding: 0.75em;
            border-radius: 4px;
        }

        .success {
            background-color: rgba(144, 238, 144, 0.1);
            border: 1px solid var(--success-color);
            color: var(--success-color);
        }

        .warning {
            background-color: rgba(255, 215, 0, 0.1);
            border: 1px solid var(--warning-color);
            color: var(--warning-color);
        }

        .error {
            background-color: rgba(255, 107, 107, 0.1);
            border: 1px solid var(--error-color);
            color: var(--error-color);
        }

        .info-box {
            margin: 1em 0;
            padding: 1em;
            background-color: var(--highlight-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }

        .route-preview {
            border: 1px solid var(--border-color);
            background-color: var(--highlight-color);
            padding: 1em;
            margin: 1em 0;
            border-radius: 4px;
        }

        .ride-item {
            border: 1px solid var(--input-border);
            background-color: var(--input-bg);
            padding: 1em;
            margin: 0.5em 0;
            border-radius: 4px;
            position: relative;
        }

        .ride-item.transfer {
            border-left: 4px solid var(--warning-color);
        }

        .ride-item.editing {
            border-color: var(--success-color);
            box-shadow: 0 0 5px rgba(144, 238, 144, 0.3);
        }

        .ride-controls {
            display: flex;
            gap: 0.5em;
            margin-top: 0.5em;
            flex-wrap: wrap;
        }

        .ride-controls button {
            padding: 0.25em 0.5em;
            font-size: 0.8em;
            margin: 0;
            min-width: auto;
        }

        .edit-button {
            background-color: var(--success-color);
            color: var(--bg-color);
        }

        .delete-button {
            background-color: var(--error-color);
            color: white;
        }

        .add-button {
            background-color: var(--warning-color);
            color: var(--bg-color);
        }

        .save-button {
            background-color: var(--success-color);
            color: var(--bg-color);
        }

        .cancel-button {
            background-color: var(--input-border);
            color: var(--text-color);
        }

        .inline-edit {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.5em;
            margin: 0.5em 0;
        }

        .inline-edit select,
        .inline-edit input {
            padding: 0.5em;
            background-color: var(--input-bg);
            border: 1px solid var(--input-border);
            color: var(--text-color);
            font-size: 0.9em;
        }

        .ride-counter {
            position: absolute;
            top: -10px;
            right: 10px;
            background-color: var(--highlight-color);
            border: 1px solid var(--input-border);
            border-radius: 50%;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            font-weight: bold;
        }

        .ride-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.5em;
            margin: 0.5em 0;
        }

        .ride-detail {
            font-size: 0.9em;
        }

        .ride-detail strong {
            color: var(--success-color);
        }

        .hidden {
            display: none;
        }

        @media (max-width: 600px) {
            .nav-links {
                flex-direction: column;
            }

            .nav-links a {
                text-align: center;
            }

            .ride-details {
                grid-template-columns: 1fr;
            }
        }
    </style>
    <script>
        // Load subway stations data
        let stopsByLine = {};

        async function loadSubwayData() {
            try {
                const response = await fetch('../../data/stops.json');
                stopsByLine = await response.json();
                console.log('‚úÖ Loaded subway data');
            } catch (error) {
                console.error('‚ùå Failed to load subway data:', error);
            }
        }

        // Load data when page loads
        document.addEventListener('DOMContentLoaded', loadSubwayData);
    </script>
</head>

<body>
    <div class="container">
        <nav class="nav-links">
            <a href="../">Record Ride</a>
            <a href="." class="active">Import Route</a>
            <a href="../stats/">Ride Statistics</a>
        </nav>

        <h1>Import Subway Route üìã</h1>

        <div>
            <h2>Import from Google Maps Link</h2>
            <p>Paste a Google Maps link with transit directions to automatically extract subway route information:</p>

            <label for="mapsUrl">Google Maps Link:</label>
            <input type="url" id="mapsUrl" placeholder="https://www.google.com/maps/... or https://maps.app.goo.gl/...">

            <div class="info-box">
                <h3>How to get a Google Maps link:</h3>
                <ol style="margin: 0.5em 0; padding-left: 1.5em;">
                    <li>Open Google Maps and search for your destination</li>
                    <li>Click "Directions" and select transit/subway mode üöá</li>
                    <li>Choose your preferred route</li>
                    <li>Click "Share" and copy the link</li>
                    <li>Paste the link above and click "Import Route"</li>
                </ol>
                <p style="margin: 0.5em 0; font-size: 0.9em; color: #888;">
                    <strong>Example URLs that work:</strong><br>
                    ‚Ä¢ https://www.google.com/maps/dir/...<br>
                    ‚Ä¢ https://maps.google.com/...<br>
                    ‚Ä¢ https://maps.app.goo.gl/...
                </p>
            </div>

            <button id="parseButton" onclick="parseFromLink()">Import Route</button>
            <button id="clearButton" onclick="clearAll()">Clear</button>
        </div>

        <div id="messageArea"></div>

        <div id="routePreview" class="route-preview hidden">
            <h2>Parsed Route</h2>
            <p>Please review the parsed rides below and make any corrections before submitting:</p>
            <div id="parsedRides"></div>
            <div style="margin-top: 1em;">
                <button id="confirmButton" onclick="confirmAndSubmit()">Confirm & Submit All Rides</button>
                <button onclick="clearAll()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        const backendUrl = `https://subway-tracker-production.up.railway.app`;
        let parsedRidesData = [];

        // Password validation function
        async function validatePassword(operation = "modify data") {
            const password = prompt(`Please enter the admin password to ${operation}:`);

            if (!password) {
                return false; // User cancelled
            }

            try {
                const response = await fetch(`${backendUrl}/validate-password`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ password: password })
                });

                if (response.ok) {
                    return true;
                } else {
                    const errorData = await response.json();
                    alert(`‚ùå ${errorData.detail || 'Invalid password'}`);
                    return false;
                }
            } catch (error) {
                console.error("Password validation error:", error);
                alert(`‚ùå Error validating password: ${error.message}`);
                return false;
            }
        }

        function showMessage(text, type = 'success') {
            const messageArea = document.getElementById('messageArea');
            messageArea.innerHTML = `<div class="message ${type}">${text}</div>`;
            setTimeout(() => {
                messageArea.innerHTML = '';
            }, 5000);
        }

        function clearAll() {
            document.getElementById('mapsUrl').value = '';
            document.getElementById('routePreview').classList.add('hidden');
            document.getElementById('messageArea').innerHTML = '';
            parsedRidesData = [];
        }

        function isValidGoogleMapsUrl(url) {
            try {
                const urlObj = new URL(url);
                const hostname = urlObj.hostname || '';
                const path = urlObj.pathname || '';

                // Support various Google Maps URL formats:
                // - https://maps.google.com/...
                // - https://www.google.com/maps/...
                // - https://maps.app.goo.gl/...
                // - https://goo.gl/maps/...
                return (
                    hostname.includes('maps.google.com') ||
                    (hostname.includes('google.com') && path.includes('/maps')) ||
                    hostname.includes('maps.app.goo.gl') ||
                    hostname.includes('goo.gl')
                );
            } catch {
                return false;
            }
        }

        async function parseFromLink() {
            const mapsUrl = document.getElementById('mapsUrl').value.trim();

            if (!mapsUrl) {
                showMessage('Please enter a Google Maps link first.', 'warning');
                return;
            }

            if (!isValidGoogleMapsUrl(mapsUrl)) {
                showMessage('Please enter a valid Google Maps link. The link should be from Google Maps (maps.google.com, www.google.com/maps, or maps.app.goo.gl)', 'warning');
                return;
            }

            const button = document.getElementById('parseButton');
            button.disabled = true;
            button.textContent = 'Importing Route...';

            try {
                // Step 1: Initial validation
                showMessage('Step 1/5: Validating Google Maps URL...', 'success');
                await new Promise(resolve => setTimeout(resolve, 500)); // Brief pause for UX

                // Step 2: Fetching data
                showMessage('Step 2/5: Fetching route data from Google Maps...', 'success');
                await new Promise(resolve => setTimeout(resolve, 300));

                // Step 3: Parsing content
                showMessage('Step 3/5: Parsing directions and extracting transit data...', 'success');

                // Extract route data from Google Maps URL using our backend
                const routeData = await extractRouteFromGoogleMaps(mapsUrl);

                if (!routeData || routeData.length === 0) {
                    showMessage('Step 3/5: ‚ùå No subway/transit routes found in this Google Maps link. Make sure the link includes transit directions with subway information.', 'warning');
                    return;
                }

                // Step 4: Validation
                showMessage('Step 4/5: Validating extracted subway stops and lines...', 'success');
                await new Promise(resolve => setTimeout(resolve, 300));

                parsedRidesData = routeData;

                // Step 5: Complete
                showMessage('Step 5/5: ‚úÖ Processing complete! Review your parsed route below.', 'success');

                displayParsedRoute();

                // Final success message
                setTimeout(() => {
                    showMessage(`Successfully extracted ${parsedRidesData.length} ride(s) from the route. Please review and confirm.`, 'success');
                }, 1000);

            } catch (error) {
                const currentStep = error.message.includes('fetch') ? '2/5' : '3/5';
                showMessage(`Step ${currentStep}: ‚ùå Error importing route: ${error.message}`, 'error');
                console.error('Import error:', error);
            } finally {
                button.disabled = false;
                button.textContent = 'Import Route';
            }
        }

        async function extractRouteFromGoogleMaps(url) {
            try {
                // Use our backend endpoint to parse the Google Maps URL
                const response = await fetch(`${backendUrl}/parse-url/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ url: url })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                // Convert backend response to our expected format
                return data.rides.map(ride => ({
                    line: ride.line,
                    board_stop: ride.board_stop,
                    depart_stop: ride.depart_stop,
                    transferred: ride.transferred,
                    confidence: ride.confidence,
                    date: new Date().toISOString().split('T')[0]
                }));

            } catch (error) {
                if (error.message.includes('404')) {
                    throw new Error('No subway/transit information found in this Google Maps link. Please make sure you\'re sharing a transit route with subway directions.');
                }
                throw new Error(`Failed to extract route information: ${error.message}`);
            }
        }

        function displayParsedRoute() {
            const preview = document.getElementById('routePreview');
            const container = document.getElementById('parsedRides');

            container.innerHTML = '';

            parsedRidesData.forEach((ride, index) => {
                const rideDiv = document.createElement('div');
                rideDiv.className = `ride-item ${ride.transferred ? 'transfer' : ''}`;
                rideDiv.setAttribute('data-ride-index', index);

                rideDiv.innerHTML = `
                    <div class="ride-counter">${index + 1}</div>
                    <div class="ride-display" id="display-${index}">
                        <h3>Ride ${index + 1} ${ride.transferred ? '(Transfer)' : ''}</h3>
                        <div class="ride-details">
                            <div class="ride-detail"><strong>Line:</strong> ${ride.line}</div>
                            <div class="ride-detail"><strong>From:</strong> ${ride.board_stop}</div>
                            <div class="ride-detail"><strong>To:</strong> ${ride.depart_stop}</div>
                            <div class="ride-detail"><strong>Date:</strong> ${ride.date || 'Not set'}</div>
                            <div class="ride-detail"><strong>Transfer:</strong> ${ride.transferred ? 'Yes' : 'No'}</div>
                        </div>
                    </div>
                    <div class="ride-edit hidden" id="edit-${index}">
                        <h3>Edit Ride ${index + 1}</h3>
                        <div class="inline-edit">
                            <div>
                                <label>Line:</label>
                                <select id="edit-line-${index}">
                                    ${generateLineOptions(ride.line)}
                                </select>
                            </div>
                            <div>
                                <label>From Station:</label>
                                <select id="edit-board-${index}">
                                    <option value="">Select station</option>
                                </select>
                            </div>
                            <div>
                                <label>To Station:</label>
                                <select id="edit-depart-${index}">
                                    <option value="">Select station</option>
                                </select>
                            </div>
                            <div>
                                <label>Date:</label>
                                <input type="date" id="edit-date-${index}" value="${ride.date || ''}" />
                            </div>
                            <div>
                                <label>Transfer:</label>
                                <select id="edit-transfer-${index}">
                                    <option value="false" ${!ride.transferred ? 'selected' : ''}>No</option>
                                    <option value="true" ${ride.transferred ? 'selected' : ''}>Yes</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="ride-controls">
                        <button class="edit-button" onclick="editRide(${index})">Edit</button>
                        <button class="delete-button" onclick="deleteRide(${index})">Delete</button>
                        <button class="add-button" onclick="addRideBefore(${index})">Add Before</button>
                        <button class="add-button" onclick="addRideAfter(${index})">Add After</button>
                        <button class="save-button hidden" onclick="saveRideEdit(${index})">Save</button>
                        <button class="cancel-button hidden" onclick="cancelRideEdit(${index})">Cancel</button>
                    </div>
                `;

                container.appendChild(rideDiv);

                // Set up line change handlers for this ride
                setupLineChangeHandler(index);
            });

            preview.classList.remove('hidden');
        }

        function generateLineOptions(selectedLine) {
            const lines = Object.keys(stopsByLine).sort();
            return lines.map(line =>
                `<option value="${line}" ${line === selectedLine ? 'selected' : ''}>${line}</option>`
            ).join('');
        }

        function setupLineChangeHandler(index) {
            const lineSelect = document.getElementById(`edit-line-${index}`);
            const boardSelect = document.getElementById(`edit-board-${index}`);
            const departSelect = document.getElementById(`edit-depart-${index}`);

            if (lineSelect) {
                lineSelect.addEventListener('change', () => {
                    const selectedLine = lineSelect.value;
                    const stops = stopsByLine[selectedLine] || [];

                    // Update both station selects
                    [boardSelect, departSelect].forEach(select => {
                        if (select) {
                            const currentValue = select.value;
                            select.innerHTML = '<option value="">Select station</option>';
                            stops.forEach(stop => {
                                const option = document.createElement('option');
                                option.value = stop;
                                option.textContent = stop;
                                if (stop === currentValue) option.selected = true;
                                select.appendChild(option);
                            });
                        }
                    });
                });

                // Trigger initial population
                lineSelect.dispatchEvent(new Event('change'));

                // Set current values
                const currentRide = parsedRidesData[index];
                if (boardSelect) boardSelect.value = currentRide.board_stop;
                if (departSelect) departSelect.value = currentRide.depart_stop;
            }
        }

        function editRide(index) {
            const rideDiv = document.querySelector(`[data-ride-index="${index}"]`);
            const displayDiv = rideDiv.querySelector(`#display-${index}`);
            const editDiv = rideDiv.querySelector(`#edit-${index}`);
            const controls = rideDiv.querySelectorAll('.ride-controls button');

            rideDiv.classList.add('editing');
            displayDiv.classList.add('hidden');
            editDiv.classList.remove('hidden');

            // Show save/cancel, hide other buttons
            controls.forEach(btn => {
                if (btn.classList.contains('save-button') || btn.classList.contains('cancel-button')) {
                    btn.classList.remove('hidden');
                } else {
                    btn.classList.add('hidden');
                }
            });
        }

        function saveRideEdit(index) {
            const lineSelect = document.getElementById(`edit-line-${index}`);
            const boardSelect = document.getElementById(`edit-board-${index}`);
            const departSelect = document.getElementById(`edit-depart-${index}`);
            const dateInput = document.getElementById(`edit-date-${index}`);
            const transferSelect = document.getElementById(`edit-transfer-${index}`);

            // Validate required fields
            if (!lineSelect.value || !boardSelect.value || !departSelect.value || !dateInput.value) {
                showMessage('Please fill in all required fields (Line, From Station, To Station, Date)', 'error');
                return;
            }

            // Update the ride data
            parsedRidesData[index] = {
                ...parsedRidesData[index],
                line: lineSelect.value,
                board_stop: boardSelect.value,
                depart_stop: departSelect.value,
                date: dateInput.value,
                transferred: transferSelect.value === 'true'
            };

            cancelRideEdit(index);
            displayParsedRoute(); // Refresh the display
        }

        function cancelRideEdit(index) {
            const rideDiv = document.querySelector(`[data-ride-index="${index}"]`);
            const displayDiv = rideDiv.querySelector(`#display-${index}`);
            const editDiv = rideDiv.querySelector(`#edit-${index}`);
            const controls = rideDiv.querySelectorAll('.ride-controls button');

            rideDiv.classList.remove('editing');
            displayDiv.classList.remove('hidden');
            editDiv.classList.add('hidden');

            // Show normal buttons, hide save/cancel
            controls.forEach(btn => {
                if (btn.classList.contains('save-button') || btn.classList.contains('cancel-button')) {
                    btn.classList.add('hidden');
                } else {
                    btn.classList.remove('hidden');
                }
            });
        }

        function deleteRide(index) {
            if (confirm(`Delete ride ${index + 1}?`)) {
                parsedRidesData.splice(index, 1);
                displayParsedRoute(); // Refresh the display
            }
        }

        function addRideBefore(index) {
            addNewRide(index);
        }

        function addRideAfter(index) {
            addNewRide(index + 1);
        }

        function addNewRide(insertIndex) {
            // Get current date in EST timezone for the database
            const today = new Date();
            // Convert to EST by adjusting for timezone offset
            const estOffset = -5 * 60; // EST is UTC-5 (in minutes)
            const estDate = new Date(today.getTime() + (estOffset - today.getTimezoneOffset()) * 60000);
            const currentDate = estDate.toISOString().split('T')[0]; // Format as YYYY-MM-DD

            const newRide = {
                line: "",
                board_stop: "",
                depart_stop: "",
                date: currentDate, // Default to today's date in EST
                transferred: false
            };

            parsedRidesData.splice(insertIndex, 0, newRide);
            displayParsedRoute(); // Refresh the display

            // Automatically start editing the new ride
            setTimeout(() => editRide(insertIndex), 100);
        } async function confirmAndSubmit() {
            if (parsedRidesData.length === 0) {
                showMessage('No rides to submit.', 'warning');
                return;
            }

            // Validate password before submitting rides
            if (!(await validatePassword(`import ${parsedRidesData.length} ride(s)`))) {
                return;
            }

            const button = document.getElementById('confirmButton');
            button.disabled = true;
            button.textContent = 'Submitting...';

            try {
                let successCount = 0;
                let errorCount = 0;
                const errors = [];

                for (const ride of parsedRidesData) {
                    try {
                        const response = await fetch(`${backendUrl}/rides/`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                line: ride.line,
                                board_stop: ride.board_stop,
                                depart_stop: ride.depart_stop,
                                date: ride.date,
                                transferred: ride.transferred
                            })
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }

                        successCount++;
                    } catch (error) {
                        errorCount++;
                        errors.push(`Ride ${successCount + errorCount}: ${error.message}`);
                    }
                }

                if (errorCount === 0) {
                    showMessage(`Successfully submitted ${successCount} ride(s)!`, 'success');
                    clearAll();
                } else {
                    showMessage(`Submitted ${successCount} ride(s) successfully, but ${errorCount} failed:\n${errors.join('\n')}`, 'warning');
                }

            } catch (error) {
                showMessage(`Error submitting rides: ${error.message}`, 'error');
            } finally {
                button.disabled = false;
                button.textContent = 'Confirm & Submit All Rides';
            }
        }
    </script>
</body>

</html>