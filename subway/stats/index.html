<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ride Statistics</title>
    <link rel="icon" type="image/x-icon" href="../../forrest.ico">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-color: #121212;
            --text-color: #e0e0e0;
            --border-color: #333;
            --highlight-color: #1e1e1e;
            --input-bg: #1e1e1e;
            --input-border: #444;
            --button-bg: #333;
            --button-text: #fff;
            --button-active: #555;
            --primary-color: #4CAF50;
            --secondary-color: #2196F3;
            --accent-color: #FF9800;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: sans-serif;
            margin: 1em;
        }

        .container {
            max-width: 100%;
            padding: 1em;
            box-sizing: border-box;
        }

        .nav-links {
            margin-bottom: 2em;
            display: flex;
            gap: 1em;
            flex-wrap: wrap;
        }

        .nav-links a {
            color: var(--text-color);
            text-decoration: none;
            padding: 0.5em 1em;
            border: 1px solid var(--input-border);
            background-color: var(--input-bg);
            border-radius: 4px;
        }

        .nav-links a:hover {
            background-color: #444;
        }

        .nav-links a.active {
            background-color: var(--button-bg);
        }

        .filter-bar {
            background-color: var(--highlight-color);
            padding: 1em;
            margin-bottom: 2em;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            display: flex;
            justify-content: center;
            gap: 0.5em;
            flex-wrap: wrap;
        }

        .filter-button {
            background-color: var(--button-bg);
            color: var(--button-text);
            border: 1px solid var(--input-border);
            padding: 0.75em 1em;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
        }

        .filter-button:hover {
            background-color: #444;
        }

        .filter-button.active {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 1em;
            margin-bottom: 2em;
        }

        .chart-container {
            background-color: var(--highlight-color);
            padding: 1em;
            border-radius: 4px;
            border: 1px solid var(--border-color);
        }

        .chart-title {
            font-size: 1.2rem;
            margin-bottom: 1em;
            color: var(--primary-color);
            text-align: center;
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
            margin-bottom: 1rem;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 400px;
            color: #888;
            font-size: 1.2rem;
        }

        .error {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 400px;
            color: #ff6b6b;
            text-align: center;
            flex-direction: column;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1em;
            margin-bottom: 2em;
        }

        .summary-card {
            background-color: var(--highlight-color);
            padding: 1em;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            text-align: center;
        }

        .summary-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .summary-label {
            color: #bbb;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 0.5em;
            }

            .stats-grid {
                grid-template-columns: 1fr;
                gap: 1em;
            }

            .filter-bar {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-button {
                width: 100%;
            }

            .chart-container {
                padding: 0.5em;
            }

            .summary-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .no-data {
            text-align: center;
            color: #888;
            font-style: italic;
            margin: 2rem 0;
        }
    </style>
</head>

<body>
    <div class="container">
        <nav class="nav-links">
            <a href="../">Record Ride</a>
            <a href="../import-ride/">Import Route</a>
            <a href="." class="active">Ride Statistics</a>
        </nav>

        <h1>Ride Statistics</h1>

        <div class="filter-bar">
            <button class="filter-button active" data-filter="all">All Time</button>
            <button class="filter-button" data-filter="year">This Year</button>
            <button class="filter-button" data-filter="month">This Month</button>
            <button class="filter-button" data-filter="week">This Week</button>
            <button class="filter-button" data-filter="day">Today</button>
        </div>

        <div class="summary-stats" id="summaryStats">
            <div class="summary-card">
                <div class="summary-value" id="totalRides">-</div>
                <div class="summary-label">Total Rides</div>
            </div>
            <div class="summary-card">
                <div class="summary-value" id="uniqueStops">-</div>
                <div class="summary-label">Unique Stops</div>
            </div>
            <div class="summary-card">
                <div class="summary-value" id="uniqueLines">-</div>
                <div class="summary-label">Lines Used</div>
            </div>
            <div class="summary-card">
                <div class="summary-value" id="transferRate">-</div>
                <div class="summary-label">Transfer Rate</div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="chart-container">
                <div class="chart-title">Most Visited Stops</div>
                <div class="chart-wrapper">
                    <canvas id="visitedStopsChart"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-title">Most Transferred At Stops</div>
                <div class="chart-wrapper">
                    <canvas id="transferStopsChart"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-title">Most Popular Lines</div>
                <div class="chart-wrapper">
                    <canvas id="popularLinesChart"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-title">Rides Over Time</div>
                <div class="chart-wrapper">
                    <canvas id="ridesOverTimeChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const backendUrl = `https://subway-tracker-production.up.railway.app`;
        console.log('üîß Backend URL configured as:', backendUrl);
        console.log('üåê Current page protocol:', window.location.protocol);
        console.log('üåê Current page host:', window.location.host);
        let currentFilter = 'all';
        let charts = {};

        // Chart color schemes
        const colors = {
            primary: '#4CAF50',
            secondary: '#2196F3',
            accent: '#FF9800',
            danger: '#F44336',
            warning: '#FFC107',
            info: '#00BCD4',
            gradient: [
                '#4CAF50', '#2196F3', '#FF9800', '#F44336', '#9C27B0',
                '#607D8B', '#795548', '#3F51B5', '#009688', '#FFC107'
            ]
        };

        // Official MTA line colors
        const mtaLineColors = {
            '1': '#EE352E', // Red
            '2': '#EE352E', // Red
            '3': '#EE352E', // Red
            '4': '#00933C', // Green
            '5': '#00933C', // Green
            '6': '#00933C', // Green
            '6X': '#00933C', // Green (6 Express)
            '7': '#B933AD', // Purple
            '7X': '#B933AD', // Purple (7 Express)
            'A': '#0039A6', // Blue
            'B': '#FF6319', // Orange
            'C': '#0039A6', // Blue
            'D': '#FF6319', // Orange
            'E': '#0039A6', // Blue
            'F': '#FF6319', // Orange
            'FX': '#FF6319', // Orange (F Express)
            'G': '#6CBE45', // Light Green
            'H': '#0039A6', // Blue (Shuttle)
            'J': '#996633', // Brown
            'L': '#A7A9AC', // Gray
            'M': '#FF6319', // Orange
            'N': '#FCCC0A', // Yellow
            'Q': '#FCCC0A', // Yellow
            'R': '#FCCC0A', // Yellow
            'S': '#808183', // Gray (Shuttle)
            'T': '#00ADD0', // Teal
            'W': '#FCCC0A', // Yellow
            'Z': '#996633', // Brown
            'SIR': '#0039A6' // Blue (Staten Island Railway)
        };

        // Get MTA color for a line
        function getMTAColor(line) {
            return mtaLineColors[line] || '#808183'; // Default to gray if line not found
        }

        // Consolidate stops that serve multiple lines
        function consolidateStopsByLines(stopData, rides) {
            const consolidatedStops = {};
            const stopLineUsage = {};

            // First, track which lines are used at each stop and how frequently
            rides.forEach(ride => {
                const boardStop = ride.board_stop;
                const departStop = ride.depart_stop;
                const line = ride.line;

                [boardStop, departStop].forEach(stop => {
                    if (stop) {
                        if (!stopLineUsage[stop]) {
                            stopLineUsage[stop] = {};
                        }
                        stopLineUsage[stop][line] = (stopLineUsage[stop][line] || 0) + 1;
                    }
                });
            });

            // Process the stop data and consolidate
            stopData.forEach(item => {
                const stopName = item.stop_name;
                const count = item.visit_count || item.transfer_count;

                // Find the most frequently used line at this stop
                let primaryLine = null;
                let maxUsage = 0;

                if (stopLineUsage[stopName]) {
                    for (const [line, usage] of Object.entries(stopLineUsage[stopName])) {
                        if (usage > maxUsage) {
                            maxUsage = usage;
                            primaryLine = line;
                        }
                    }
                }

                // Use the primary line or default
                const lineForColor = primaryLine || 'S'; // Default to shuttle gray

                if (!consolidatedStops[stopName]) {
                    consolidatedStops[stopName] = {
                        stop_name: stopName,
                        count: count,
                        primary_line: lineForColor,
                        lines: stopLineUsage[stopName] ? Object.keys(stopLineUsage[stopName]) : [],
                        color: getMTAColor(lineForColor)
                    };
                } else {
                    // This shouldn't happen in our current data structure, but just in case
                    consolidatedStops[stopName].count += count;
                }
            });

            return Object.values(consolidatedStops).sort((a, b) => b.count - a.count);
        }

        // Consolidate line data and get colors
        function processLineData(lineData) {
            return lineData.map(item => ({
                ...item,
                color: getMTAColor(item.line)
            }));
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', async () => {
            setupFilterButtons();
            await loadAllData();
        });

        // Setup filter button functionality
        function setupFilterButtons() {
            document.querySelectorAll('.filter-button').forEach(button => {
                button.addEventListener('click', async () => {
                    // Update active button
                    document.querySelectorAll('.filter-button').forEach(b => b.classList.remove('active'));
                    button.classList.add('active');

                    // Update current filter and reload data
                    currentFilter = button.dataset.filter;
                    await loadAllData();
                });
            });
        }

        // Get date filter for API calls
        function getDateFilter() {
            const now = new Date();
            const est = new Date(now.getTime() + (-5 * 60 - now.getTimezoneOffset()) * 60000);

            switch (currentFilter) {
                case 'day':
                    return est.toISOString().split('T')[0];
                case 'week':
                    const weekAgo = new Date(est);
                    weekAgo.setDate(weekAgo.getDate() - 7);
                    return weekAgo.toISOString().split('T')[0];
                case 'month':
                    const monthAgo = new Date(est);
                    monthAgo.setMonth(monthAgo.getMonth() - 1);
                    return monthAgo.toISOString().split('T')[0];
                case 'year':
                    const yearAgo = new Date(est);
                    yearAgo.setFullYear(yearAgo.getFullYear() - 1);
                    return yearAgo.toISOString().split('T')[0];
                default:
                    return null;
            }
        }

        // Load all data and update charts
        async function loadAllData() {
            try {
                showLoading();
                const dateFilter = getDateFilter();
                const params = dateFilter ? `?since=${dateFilter}` : '';

                console.log('üîç Loading data with URLs:');
                console.log(`- Rides: ${backendUrl}/rides/${params}`);
                console.log(`- Visited: ${backendUrl}/stats/visited-stops${params}`);
                console.log(`- Transfers: ${backendUrl}/stats/transfer-stops${params}`);
                console.log(`- Lines: ${backendUrl}/stats/popular-lines${params}`);

                // Fetch all data with proper trailing slashes and error handling
                const [ridesResponse, visitedResponse, transfersResponse, linesResponse] = await Promise.all([
                    fetch(`${backendUrl}/rides/${params}`, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json',
                        },
                        mode: 'cors'
                    }),
                    fetch(`${backendUrl}/stats/visited-stops${params}`, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json',
                        },
                        mode: 'cors'
                    }),
                    fetch(`${backendUrl}/stats/transfer-stops${params}`, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json',
                        },
                        mode: 'cors'
                    }),
                    fetch(`${backendUrl}/stats/popular-lines${params}`, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json',
                        },
                        mode: 'cors'
                    })
                ]);

                console.log('üì° Response status codes:', {
                    rides: ridesResponse.status,
                    visited: visitedResponse.status,
                    transfers: transfersResponse.status,
                    lines: linesResponse.status
                });

                if (!ridesResponse.ok || !visitedResponse.ok || !transfersResponse.ok || !linesResponse.ok) {
                    const errors = [];
                    if (!ridesResponse.ok) errors.push(`Rides: ${ridesResponse.status} ${ridesResponse.statusText}`);
                    if (!visitedResponse.ok) errors.push(`Visited: ${visitedResponse.status} ${visitedResponse.statusText}`);
                    if (!transfersResponse.ok) errors.push(`Transfers: ${transfersResponse.status} ${transfersResponse.statusText}`);
                    if (!linesResponse.ok) errors.push(`Lines: ${linesResponse.status} ${linesResponse.statusText}`);
                    throw new Error('API Errors: ' + errors.join(', '));
                }

                const rides = await ridesResponse.json();
                const visitedStops = await visitedResponse.json();
                const transferStops = await transfersResponse.json();
                const popularLines = await linesResponse.json();

                console.log('‚úÖ Data loaded successfully:', {
                    rides: rides.rides ? rides.rides.length : 'N/A',
                    visitedStops: visitedStops.length,
                    transferStops: transferStops.length,
                    popularLines: popularLines.length
                });

                // Extract rides array from API response
                const ridesArray = rides.rides || [];

                // Ensure all canvas elements exist before updating charts
                ensureCanvasElements();

                // Update summary stats with filtered data
                updateSummaryStats(ridesArray, visitedStops, transferStops, popularLines);

                // Update charts immediately - no delay needed since we're ensuring elements exist
                console.log('üé® Starting chart updates...');
                updateVisitedStopsChart(visitedStops, ridesArray);
                updateTransferStopsChart(transferStops, ridesArray);
                updatePopularLinesChart(popularLines);
                updateRidesOverTimeChart(ridesArray);
                console.log('üé® Chart updates completed');

            } catch (error) {
                console.error('‚ùå Error loading data:', error);
                console.error('‚ùå Error details:', {
                    name: error.name,
                    message: error.message,
                    stack: error.stack
                });

                // Check if this is a CORS/network error
                if (error.name === 'TypeError' && error.message.includes('NetworkError')) {
                    showError(`Network error: Cannot connect to backend. Check CORS and URL configuration. Backend URL: ${backendUrl}`);
                } else {
                    showError(`Failed to load statistics data: ${error.message}`);
                }
            }
        }

        function showLoading() {
            document.querySelectorAll('.chart-wrapper').forEach(wrapper => {
                wrapper.innerHTML = '<div class="loading">Loading data...</div>';
            });
        }

        function showError(message) {
            document.querySelectorAll('.chart-wrapper').forEach(wrapper => {
                wrapper.innerHTML = `<div class="error"><strong>Error:</strong><br>${message}</div>`;
            });
        }

        // Ensure all canvas elements exist and are properly initialized
        function ensureCanvasElements() {
            const canvasIds = ['visitedStopsChart', 'transferStopsChart', 'popularLinesChart', 'ridesOverTimeChart'];

            canvasIds.forEach(id => {
                let canvas = document.getElementById(id);
                if (!canvas) {
                    console.log(`üîß Creating missing canvas element: ${id}`);
                    // Find the wrapper for this chart
                    const allWrappers = document.querySelectorAll('.chart-wrapper');
                    const chartTitles = ['Most Visited Stops', 'Most Transferred At Stops', 'Most Popular Lines', 'Rides Over Time'];
                    const chartIndex = canvasIds.indexOf(id);

                    if (chartIndex >= 0 && allWrappers[chartIndex]) {
                        allWrappers[chartIndex].innerHTML = `<canvas id="${id}"></canvas>`;
                    }
                } else {
                    // Clear any loading/error content from wrapper but keep canvas
                    const wrapper = canvas.closest('.chart-wrapper');
                    if (wrapper) {
                        const loadingOrError = wrapper.querySelector('.loading, .error, .no-data');
                        if (loadingOrError) {
                            wrapper.innerHTML = `<canvas id="${id}"></canvas>`;
                        }
                    }
                }
            });

            console.log('üîß Canvas elements verification completed');
        }

        // Update summary statistics
        function updateSummaryStats(rides, visitedStops, transferStops, popularLines) {
            console.log('üìä Updating summary stats with:', {
                rides: rides.length,
                visitedStops: visitedStops.length,
                transferStops: transferStops.length,
                popularLines: popularLines.length
            });

            const totalRides = rides.length;

            // Calculate unique stops from the filtered rides data
            const allStops = new Set();
            rides.forEach(ride => {
                if (ride.board_stop) allStops.add(ride.board_stop);
                if (ride.depart_stop) allStops.add(ride.depart_stop);
            });
            const uniqueStops = allStops.size;

            // Calculate unique lines from the filtered rides data
            const uniqueLines = new Set(rides.map(r => r.line).filter(line => line)).size;

            // Calculate transfers from the filtered rides data
            const transfers = rides.filter(r => r.transferred === true || r.transferred === 1).length;
            const transferRate = totalRides > 0 ? Math.round((transfers / totalRides) * 100) : 0;

            // Update display with animation
            animateValue('totalRides', parseInt(document.getElementById('totalRides').textContent) || 0, totalRides);
            animateValue('uniqueStops', parseInt(document.getElementById('uniqueStops').textContent) || 0, uniqueStops);
            animateValue('uniqueLines', parseInt(document.getElementById('uniqueLines').textContent) || 0, uniqueLines);
            animateValue('transferRate', parseInt(document.getElementById('transferRate').textContent) || 0, transferRate, '%');

            console.log('üìä Summary stats updated:', {
                totalRides,
                uniqueStops,
                uniqueLines,
                transferRate: `${transferRate}%`
            });
        }

        // Animate value changes in summary stats
        function animateValue(elementId, start, end, suffix = '') {
            const element = document.getElementById(elementId);
            if (!element) return;

            const duration = 500; // 500ms animation
            const startTime = performance.now();

            function animate(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);

                const current = Math.round(start + (end - start) * progress);
                element.textContent = current.toLocaleString() + suffix;

                if (progress < 1) {
                    requestAnimationFrame(animate);
                }
            }

            requestAnimationFrame(animate);
        }

        // Update visited stops chart
        function updateVisitedStopsChart(data, rides) {
            const chartElement = document.getElementById('visitedStopsChart');
            if (!chartElement) {
                console.error('‚ùå visitedStopsChart element not found after ensureCanvasElements');
                return;
            }

            console.log('üéØ Updating visited stops chart with', data.length, 'items');

            // Destroy existing chart
            if (charts.visitedStops) {
                charts.visitedStops.destroy();
                delete charts.visitedStops;
            }

            if (!data || data.length === 0) {
                const chartWrapper = chartElement.closest('.chart-wrapper');
                if (chartWrapper) {
                    chartWrapper.innerHTML = '<div class="no-data">No visited stops data for this time period</div>';
                }
                return;
            }

            // Consolidate stops and get colors
            const consolidatedData = consolidateStopsByLines(data, rides);
            const top10Data = consolidatedData.slice(0, 10);

            const ctx = chartElement.getContext('2d');
            if (!ctx) {
                console.error('‚ùå Could not get canvas context for visitedStopsChart');
                return;
            }

            charts.visitedStops = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: top10Data.map(item => {
                        const lines = item.lines.join('/');
                        return lines ? `${item.stop_name} (${lines})` : item.stop_name;
                    }),
                    datasets: [{
                        label: 'Visits',
                        data: top10Data.map(item => item.count),
                        backgroundColor: top10Data.map(item => item.color),
                        borderColor: top10Data.map(item => item.color),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#e0e0e0'
                            },
                            grid: {
                                color: '#333'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#e0e0e0',
                                maxRotation: 45
                            },
                            grid: {
                                color: '#333'
                            }
                        }
                    }
                }
            });

            console.log('‚úÖ Visited stops chart created successfully');
        }

        // Update transfer stops chart
        function updateTransferStopsChart(data, rides) {
            const chartElement = document.getElementById('transferStopsChart');
            if (!chartElement) {
                console.error('‚ùå transferStopsChart element not found after ensureCanvasElements');
                return;
            }

            console.log('üéØ Updating transfer stops chart with', data.length, 'items');

            // Destroy existing chart
            if (charts.transferStops) {
                charts.transferStops.destroy();
                delete charts.transferStops;
            }

            if (!data || data.length === 0) {
                const chartWrapper = chartElement.closest('.chart-wrapper');
                if (chartWrapper) {
                    chartWrapper.innerHTML = '<div class="no-data">No transfer data for this time period</div>';
                }
                return;
            }

            // Consolidate stops and get colors
            const consolidatedData = consolidateStopsByLines(data, rides);
            const top10Data = consolidatedData.slice(0, 10);

            const ctx = chartElement.getContext('2d');
            if (!ctx) {
                console.error('‚ùå Could not get canvas context for transferStopsChart');
                return;
            }

            charts.transferStops = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: top10Data.map(item => {
                        const lines = item.lines.join('/');
                        return lines ? `${item.stop_name} (${lines})` : item.stop_name;
                    }),
                    datasets: [{
                        label: 'Transfers',
                        data: top10Data.map(item => item.count),
                        backgroundColor: top10Data.map(item => item.color),
                        borderColor: top10Data.map(item => item.color),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#e0e0e0'
                            },
                            grid: {
                                color: '#333'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#e0e0e0',
                                maxRotation: 45
                            },
                            grid: {
                                color: '#333'
                            }
                        }
                    }
                }
            });

            console.log('‚úÖ Transfer stops chart created successfully');
        }

        // Update popular lines chart
        function updatePopularLinesChart(data) {
            const chartElement = document.getElementById('popularLinesChart');
            if (!chartElement) {
                console.error('‚ùå popularLinesChart element not found after ensureCanvasElements');
                return;
            }

            console.log('üéØ Updating popular lines chart with', data.length, 'items');

            // Destroy existing chart
            if (charts.popularLines) {
                charts.popularLines.destroy();
                delete charts.popularLines;
            }

            if (!data || data.length === 0) {
                const chartWrapper = chartElement.closest('.chart-wrapper');
                if (chartWrapper) {
                    chartWrapper.innerHTML = '<div class="no-data">No line data for this time period</div>';
                }
                return;
            }

            // Process line data to add colors
            const processedData = processLineData(data);
            const top10Data = processedData.slice(0, 10);

            const ctx = chartElement.getContext('2d');
            if (!ctx) {
                console.error('‚ùå Could not get canvas context for popularLinesChart');
                return;
            }

            charts.popularLines = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: top10Data.map(item => item.line || 'Unknown'),
                    datasets: [{
                        label: 'Rides',
                        data: top10Data.map(item => item.ride_count || 0),
                        backgroundColor: top10Data.map(item => item.color),
                        borderColor: top10Data.map(item => item.color),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#e0e0e0'
                            },
                            grid: {
                                color: '#333'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#e0e0e0'
                            },
                            grid: {
                                color: '#333'
                            }
                        }
                    }
                }
            });

            console.log('‚úÖ Popular lines chart created successfully');
        }

        // Update rides over time chart
        function updateRidesOverTimeChart(rides) {
            const chartElement = document.getElementById('ridesOverTimeChart');
            if (!chartElement) {
                console.error('‚ùå ridesOverTimeChart element not found after ensureCanvasElements');
                return;
            }

            console.log('üéØ Updating rides over time chart with', rides.length, 'rides');

            // Destroy existing chart
            if (charts.ridesOverTime) {
                charts.ridesOverTime.destroy();
                delete charts.ridesOverTime;
            }

            if (!rides || rides.length === 0) {
                const chartWrapper = chartElement.closest('.chart-wrapper');
                if (chartWrapper) {
                    chartWrapper.innerHTML = '<div class="no-data">No ride data for this time period</div>';
                }
                return;
            }

            const ctx = chartElement.getContext('2d');
            if (!ctx) {
                console.error('‚ùå Could not get canvas context for ridesOverTimeChart');
                return;
            }

            // Group rides by date
            const ridesByDate = rides.reduce((acc, ride) => {
                const date = ride.date || ride.created_at?.split('T')[0] || 'Unknown';
                acc[date] = (acc[date] || 0) + 1;
                return acc;
            }, {});

            // Sort dates and prepare data
            const sortedDates = Object.keys(ridesByDate).sort();
            const rideCounts = sortedDates.map(date => ridesByDate[date]);

            charts.ridesOverTime = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedDates,
                    datasets: [{
                        label: 'Rides per Day',
                        data: rideCounts,
                        backgroundColor: 'rgba(76, 175, 80, 0.2)',
                        borderColor: colors.primary,
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#e0e0e0'
                            },
                            grid: {
                                color: '#333'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#e0e0e0',
                                maxRotation: 45
                            },
                            grid: {
                                color: '#333'
                            }
                        }
                    }
                }
            });

            console.log('‚úÖ Rides over time chart created successfully');
        }
    </script>
    </div>
</body>

</html>