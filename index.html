<!DOCTYPE html>
<!DOCTYPE html>

<html lang="en">
<html lang="en">



<head>

  <head>

    <meta charset="UTF-8">
    <meta charset="UTF-8" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>gbonez's Website</title>
    <title>NYC Subway Ride Tracker</title>

    <style>
      <style> :root {
        :root {

          --bg-color: #121212;
          --bg-color: #121212;

          --text-color: #e0e0e0;
          --text-color: #e0e0e0;

          --accent-color: #4a9eff;
          --border-color: #333;

          --accent-hover: #3b8ae8;
          --highlight-color: #1e1e1e;

          --border-color: #333;
          --input-bg: #1e1e1e;

          --highlight-color: #1e1e1e;
          --input-border: #444;

        }

        --button-bg: #333;

        --button-text: #fff;

        * {}

        margin: 0;

        padding: 0;

        body {

          box-sizing: border-box;
          background-color: var(--bg-color);

        }

        color: var(--text-color);

        font-family: sans-serif;

        body {
          margin: 1em;

          background-color: var(--bg-color);
        }

        color: var(--text-color);

        font-family: -apple-system,
        BlinkMacSystemFont,
        'Segoe UI',
        Roboto,
        Oxygen,
        Ubuntu,
        Cantarell,
        sans-serif;

        .container {

          min-height: 100vh;
          max-width: 100%;

          display: flex;
          padding: 1em;

          flex-direction: column;
          box-sizing: border-box;

          justify-content: center;
        }

        align-items: center;

        text-align: center;
        select,

        padding: 2rem;
        button,

      }

      input[type="date"] {

        background-color: var(--input-bg);

        .container {
          color: var(--text-color);

          max-width: 600px;
          border: 1px solid var(--input-border);

          width: 100%;
          margin: 0.5em 0;

        }

        padding: 0.75em;

        font-size: 1rem;

        h1 {
          width: 100%;

          font-size: 3rem;
          max-width: 300px;

          margin-bottom: 1rem;
          box-sizing: border-box;

          background: linear-gradient(135deg, var(--accent-color), #6c5ce7);
        }

        -webkit-background-clip: text;

        -webkit-text-fill-color: transparent;

        button {

          background-clip: text;
          background-color: var(--button-bg);

        }

        color: var(--button-text);

        border: 1px solid var(--input-border);

        .subtitle {
          cursor: pointer;

          font-size: 1.2rem;
        }

        color: #888;

        margin-bottom: 3rem;

        button:hover {

          line-height: 1.6;
          background-color: #444;

        }
      }



      .projects-section {
        #message {

          margin-top: 2rem;
          margin-top: 1em;

        }

        color: #90ee90;

      }

      .project-card {

        background-color: var(--highlight-color);

        table {

          border: 1px solid var(--border-color);
          display: block;

          border-radius: 12px;
          overflow-x: auto;

          padding: 2rem;
          width: 100%;

          margin-bottom: 1.5rem;
          border-collapse: collapse;

          transition: all 0.3s ease;
        }

      }

      th,

      .project-card:hover {
        td {

          transform: translateY(-2px);
          border: 1px solid var(--border-color);

          border-color: var(--accent-color);
          padding: 8px 12px;

          box-shadow: 0 8px 25px rgba(74, 158, 255, 0.1);
          text-align: left;

        }
      }



      .project-title {
        th {

          font-size: 1.5rem;
          background-color: var(--highlight-color);

          margin-bottom: 0.5rem;
        }

        color: var(--text-color);

      }

      @media (max-width: 600px) {



        .project-description {
          th,

          color: #aaa;

          td {

            margin-bottom: 1.5rem;
            font-size: 0.9em;

            line-height: 1.6;
            padding: 6px 8px;

          }
        }



        .project-link {
          select,

          display: inline-block;
          button,

          background-color: var(--accent-color);

          input[type="date"] {

            color: white;
            width: 100%;

            text-decoration: none;
            max-width: 100%;

            padding: 0.75rem 1.5rem;
          }

          border-radius: 8px;

          font-weight: 500;

          label {

            transition: all 0.3s ease;
            display: block;

          }

          margin-top: 1em;

        }

        .project-link:hover {

          background-color: var(--accent-hover);

          button {

            transform: translateY(-1px);
            min-height: 44px;

            box-shadow: 0 4px 15px rgba(74, 158, 255, 0.3);
          }

        }

        th,

        .footer {
          td {

            margin-top: 3rem;
            border: 1px solid var(--border-color);

            color: #666;
          }

          font-size: 0.9rem;
        }

      }

      .pagination-wrapper {

        @media (max-width: 600px) {
          display: flex;

          h1 {
            flex-wrap: wrap;

            font-size: 2.5rem;
            align-items: center;

          }

          gap: 0.5em;

          justify-content: center;

          .subtitle {}

          font-size: 1.1rem;

        }

        @media (max-width: 600px) {

          .pagination-wrapper {

            .project-card {
              flex-direction: column;

              padding: 1.5rem;
              align-items: stretch;

            }
          }

        }
    </style> .pagination-wrapper button {

  </head> width: 100%;

  }

<body>

  <div class="container"> .pagination-wrapper span {

    <h1>Welcome to gbonez's Website</h1> text-align: center;

    <p class="subtitle"> width: 100%;

      Building useful tools and exploring technology, one project at a time. display: block;

    </p> }

    }

    <div class="projects-section">

      <div class="project-card"> .nav-links {

        <h2 class="project-title">üöá NYC Subway Tracker</h2> margin-bottom: 2em;

        <p class="project-description"> display: flex;

          Track your subway rides across New York City. Record individual trips, import routes from Google Maps, gap:
          1em;

          and keep a personal log of your transit adventures. flex-wrap: wrap;

        </p> }

        <a href="subway/" class="project-link">Launch Subway Tracker</a>

      </div> .nav-links a {

    </div> color: var(--text-color);

    text-decoration: none;

    <div class="footer"> padding: 0.5em 1em;

      <p>Built with ‚ù§Ô∏è by gbonez</p> border: 1px solid var(--input-border);

    </div> background-color: var(--input-bg);

  </div> border-radius: 4px;

</body> }



</html> .nav-links a:hover {
background-color: var(--button-bg);
}

.nav-links a.active {
background-color: var(--button-bg);
}

@media (max-width: 600px) {
.nav-links {
flex-direction: column;
}

.nav-links a {
text-align: center;
}
}
</style>
<script src="stopsByLine.js"></script>
</head>

<body>
  <div class="container">
    <nav class="nav-links">
      <a href="index.html" class="active">Record Ride</a>
      <a href="import-route.html">Import Route</a>
    </nav>

    <h1>Record a Subway Ride üöá</h1> <label for="line">Line:</label>
    <select id="line">
      <option value="">Select a line</option>
    </select><br>

    <label for="boardStop">Boarding Stop:</label>
    <select id="boardStop">
      <option value="">Select boarding stop</option>
    </select><br>

    <label for="departStop">Departing Stop:</label>
    <select id="departStop">
      <option value="">Select departing stop</option>
    </select><br>

    <label for="rideDate">Date:</label>
    <input type="date" id="rideDate" /><br>

    <label for="transferred">
      <input type="checkbox" id="transferred" />
      Did you transfer to another line at your departure stop?
    </label><br>
    <button id="submitButton" onclick="submitRide()">Submit Ride</button>
    <div id="message"></div>
    <hr />
    <div id="loading" style="display: none; font-weight: bold; margin-top: 1em;">Loading rides...</div>
    <div>
      <label for="entriesPerPage">Show entries:</label>
      <select id="entriesPerPage" onchange="changeEntriesPerPage()">
        <option value="25" selected>25</option>
        <option value="50">50</option>
        <option value="100">100</option>
        <option value="all">All</option>
      </select>
      <button onclick="fetchRides()">Refresh Table</button>
      <button onclick="clearDatabase()">Clear Table</button>
      <button onclick="exportCSV()">Export Table</button>
    </div>
    <table id="ridesTable" border="1" style="margin-top: 1em;">
      <thead>
        <tr>
          <th><button onclick="sortRides('ride_number')">Ride #</button></th>
          <th><button onclick="sortRides('line')">Line</button></th>
          <th><button onclick="sortRides('board_stop')">Boarding Stop</button></th>
          <th><button onclick="sortRides('depart_stop')">Departing Stop</button></th>
          <th><button onclick="sortRides('date')">Date</button></th>
          <th><button onclick="sortRides('transferred')">Transferred</button></th>
          <th>Delete?</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div id="paginationControls" style="margin-top: 1em;"></div>

    <script>
      const backendUrl = `https://subway-tracker-production.up.railway.app`;

      const lineSelect = document.getElementById("line");
      const boardStopSelect = document.getElementById("boardStop");
      const departStopSelect = document.getElementById("departStop");
      const messageDiv = document.getElementById("message");
      const ridesTableBody = document.querySelector("#ridesTable tbody");

      let allRides = [];
      let currentSortColumn = "ride_number";
      let currentSortDirection = "desc";
      let currentPage = 1;
      let entriesPerPage = 25;

      window.addEventListener("DOMContentLoaded", async () => {
        // Test backend connectivity first
        console.log("üîó Testing backend connectivity...");
        try {
          const healthRes = await fetch(`${backendUrl}/`);
          const healthData = await healthRes.json();
          console.log("‚úÖ Backend health check:", healthData);

          // Test database connectivity
          const dbRes = await fetch(`${backendUrl}/test-db`);
          const dbData = await dbRes.json();
          console.log("üêò Database test:", dbData);
        } catch (err) {
          console.error("‚ùå Backend connectivity failed:", err);
          messageDiv.textContent = `Cannot connect to backend: ${err.message}`;
          messageDiv.style.color = "#ff6b6b";
        }

        // Load subway lines
        const lines = Object.keys(stopsByLine).sort();
        lines.forEach(line => {
          const opt = document.createElement("option");
          opt.value = line;
          opt.textContent = line;
          lineSelect.appendChild(opt);
        });

        fetchRides();
      });

      lineSelect.addEventListener("change", () => {
        const line = lineSelect.value;
        const stops = stopsByLine[line] || [];

        [boardStopSelect, departStopSelect].forEach(select => {
          select.innerHTML = "<option value=''>Select stop</option>";
          stops.forEach(stop => {
            const opt = document.createElement("option");
            opt.value = stop;
            opt.textContent = stop;
            select.appendChild(opt);
          });
        });
      });

      async function submitRide() {
        const submitBtn = document.getElementById("submitButton");
        submitBtn.disabled = true;
        submitBtn.textContent = "Submitting...";

        const line = lineSelect.value;
        const boardStop = boardStopSelect.value;
        const departStop = departStopSelect.value;
        const rideDateInput = document.getElementById("rideDate").value;
        const transferred = document.getElementById("transferred").checked;

        if (!line || !boardStop || !departStop || !rideDateInput) {
          alert("Please fill in all fields.");
          submitBtn.disabled = false;
          submitBtn.textContent = "Submit Ride";
          return;
        }

        const data = {
          line,
          board_stop: boardStop,
          depart_stop: departStop,
          date: rideDateInput,
          transferred
        };

        try {
          const res = await fetch(`${backendUrl}/rides/`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify(data)
          });

          const result = await res.json();

          if (res.ok) {
            messageDiv.textContent = "New ride successfully recorded! ‚úÖ";
            await fetchRides();
          } else {
            messageDiv.textContent = `Error ${res.status}: ${result.detail || 'Unknown error'}`;
          }
        } catch (err) {
          console.error(err);
          messageDiv.textContent = `Error submitting ride: ${err.message}`;
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = "Submit Ride";
        }
      }

      async function fetchRides() {
        const loadingIndicator = document.getElementById("loading");
        loadingIndicator.style.display = "block";

        console.log("üîç Fetching rides from:", `${backendUrl}/rides/`);

        try {
          const res = await fetch(`${backendUrl}/rides/`);
          console.log("üì° Response status:", res.status);

          if (!res.ok) {
            const errorText = await res.text();
            console.error("‚ùå Response error:", errorText);
            throw new Error(`HTTP ${res.status}: ${errorText}`);
          }

          const data = await res.json();
          console.log("üìä Received data:", data);

          // Extract rides array from the response object
          const ridesArray = data.rides || data;
          console.log("üìä Rides array length:", ridesArray.length);

          allRides = ridesArray;
          sortRides();
          currentPage = 1;

          if (ridesArray.length === 0) {
            messageDiv.textContent = "No rides found in database. Add some rides first!";
            messageDiv.style.color = "#ffd700";
          } else {
            messageDiv.textContent = `Loaded ${ridesArray.length} rides from database ‚úÖ`;
            messageDiv.style.color = "#90ee90";
          }
        } catch (err) {
          console.error("‚ùå Fetch error:", err);
          allRides = [];
          messageDiv.textContent = `Error loading rides: ${err.message}`;
          messageDiv.style.color = "#ff6b6b";
        } finally {
          loadingIndicator.style.display = "none";
          renderTable();
        }
      }

      function sortRides(column) {
        if (column) {
          if (column === currentSortColumn) {
            currentSortDirection = currentSortDirection === "asc" ? "desc" : "asc";
          } else {
            currentSortColumn = column;
            currentSortDirection = "asc";
          }
        }

        allRides.sort((a, b) => {
          let valA = a[currentSortColumn];
          let valB = b[currentSortColumn];

          if (currentSortColumn === "date") {
            valA = new Date(valA);
            valB = new Date(valB);
          } else if (currentSortColumn === "ride_number") {
            valA = parseInt(valA, 10);
            valB = parseInt(valB, 10);
          } else {
            valA = valA?.toString().toLowerCase();
            valB = valB?.toString().toLowerCase();
          }

          if (valA < valB) return currentSortDirection === "asc" ? -1 : 1;
          if (valA > valB) return currentSortDirection === "asc" ? 1 : -1;
          return 0;
        });

        renderTable();
      }

      function changeEntriesPerPage() {
        const value = document.getElementById("entriesPerPage").value;
        entriesPerPage = value === "all" ? allRides.length : parseInt(value);
        currentPage = 1;
        renderTable();
      }

      function renderTable() {
        const tableBody = document.querySelector("#ridesTable tbody");
        tableBody.innerHTML = "";

        // Add click handlers and arrows to header
        const headerRow = document.querySelector("#ridesTable thead tr");
        const headers = headerRow.querySelectorAll("th");
        const sortableColumns = ["ride_number", "line", "board_stop", "depart_stop", "date", "transferred"];

        headers.forEach((th, i) => {
          const key = sortableColumns[i];
          if (!key) return; // Skip non-sortable (like delete)

          th.style.cursor = "pointer";
          th.onclick = () => {
            if (currentSortColumn === key) {
              currentSortDirection = currentSortDirection === "asc" ? "desc" : "asc";
            } else {
              currentSortColumn = key;
              currentSortDirection = "asc";
            }
            sortRides();
            renderTable();
          };

          // Add arrow indicator
          let arrow = "";
          if (currentSortColumn === key) {
            arrow = currentSortDirection === "asc" ? " ‚ñ≤" : " ‚ñº";
          }
          th.textContent = th.textContent.split(" ")[0] + arrow;
        });

        const start = (currentPage - 1) * entriesPerPage;
        const end = start + entriesPerPage;
        const paginatedRides = allRides.slice(start, end);

        paginatedRides.forEach(ride => {
          const row = document.createElement("tr");
          row.innerHTML = `
          <td>${ride.ride_number}</td>
          <td>${ride.line}</td>
          <td>${ride.board_stop}</td>
          <td>${ride.depart_stop}</td>
          <td>${ride.date}</td>
          <td>${ride.transferred ? "Yes" : "No"}</td>
          <td>
            <button 
              data-id="${ride.id}"
              data-ride-number="${ride.ride_number}"
              onclick="deleteRide(this)" 
              title="Delete ride" 
              style="background:none;border:none;cursor:pointer;"
            >üóëÔ∏è</button>
          </td>`;

          tableBody.appendChild(row);
        });

        renderPaginationControls();
      }

      function renderPaginationControls() {
        const totalPages = Math.ceil(allRides.length / entriesPerPage);
        const container = document.getElementById("paginationControls");
        container.innerHTML = "";

        const wrapper = document.createElement("div");
        wrapper.className = "pagination-wrapper";

        container.innerHTML = "";

        if (totalPages <= 1) return;

        const makeButton = (label, onClick, disabled = false) => {
          const btn = document.createElement("button");
          btn.textContent = label;
          btn.style.margin = "0 4px";
          btn.disabled = disabled;
          btn.onclick = onClick;
          return btn;
        };

        wrapper.appendChild(makeButton("‚èÆ First", () => {
          currentPage = 1;
          renderTable();
        }, currentPage === 1));

        wrapper.appendChild(makeButton("‚óÄ Prev", () => {
          currentPage--;
          renderTable();
        }, currentPage === 1));

        const pageDisplay = document.createElement("span");
        pageDisplay.textContent = ` Page ${currentPage} of ${totalPages} `;
        pageDisplay.style.margin = "0 8px";
        wrapper.appendChild(pageDisplay);

        wrapper.appendChild(makeButton("Next ‚ñ∂", () => {
          currentPage++;
          renderTable();
        }, currentPage === totalPages));

        wrapper.appendChild(makeButton("Last ‚è≠", () => {
          currentPage = totalPages;
          renderTable();
        }, currentPage === totalPages));

        container.appendChild(wrapper);
      }

      async function deleteRide(buttonElement) {
        const rideId = buttonElement.getAttribute("data-id");
        const rideNumber = buttonElement.getAttribute("data-ride-number");

        if (!rideId) {
          alert("Invalid ride ID");
          return;
        }

        const confirmed = confirm(`Delete ride #${rideNumber}?`);
        if (!confirmed) return;

        try {
          const res = await fetch(`${backendUrl}/rides/${rideId}`, {
            method: "DELETE"
          });

          if (res.ok) {
            await fetchRides();
          } else {
            alert("Failed to delete ride.");
          }
        } catch (err) {
          console.error("Error deleting ride:", err);
          alert("An error occurred while deleting.");
        }
      }

      async function clearDatabase() {
        if (confirm("Are you sure you want to delete all rides?")) {
          try {
            const res = await fetch(`${backendUrl}/rides/`, { method: "DELETE" });
            if (res.ok) {
              await fetchRides();
              alert("Cleared all rides from table.");
            } else {
              alert("Failed to clear rides.");
            }
          } catch (err) {
            console.error("Error clearing DB:", err);
            alert("Error clearing rides.");
          }
        }
      }

      function exportCSV() {
        window.location.href = "https://subway-tracker-production.up.railway.app/rides/export";
      }
    </script>
  </div>
</body>

</html>