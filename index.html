<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NYC Subway Ride Tracker</title>
  <style>
    body { font-family: sans-serif; margin: 2em; }
    select, button, input[type="date"] {
      margin: 0.5em 0;
      padding: 0.5em;
      width: 100%;
      max-width: 300px;
    }
    #message { margin-top: 1em; color: green; }

    table {
      margin-top: 2em;
      border-collapse: collapse;
      width: 100%;
      max-width: 900px;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 8px 12px;
      text-align: left;
    }

    th {
      background-color: #f2f2f2;
    }

  </style>
  <script src="stopsByLine.js"></script> 
</head>
<body>
  <h1>Record a Subway Ride</h1>

  <label for="line">Line:</label>
  <select id="line">
    <option value="">Select a line</option>
  </select><br>

  <label for="boardStop">Boarding Stop:</label>
  <select id="boardStop">
    <option value="">Select boarding stop</option>
  </select><br>

  <label for="departStop">Departing Stop:</label>
  <select id="departStop">
    <option value="">Select departing stop</option>
  </select><br>

  <label for="rideDate">Date:</label>
  <input type="date" id="rideDate" /><br>

  <label for="transferred">
    <input type="checkbox" id="transferred" />
    Did you transfer to another line at your departure stop?
  </label><br>
  <button id="submitButton" onclick="submitRide()">Submit Ride</button>
  <div id="message"></div>
  <hr />
  <div id="loading" style="display: none; font-weight: bold; margin-top: 1em;">Loading rides...</div>
  <div>
    <label for="entriesPerPage">Show entries:</label>
      <select id="entriesPerPage" onchange="changeEntriesPerPage()">
        <option value="25" selected>25</option>
        <option value="50">50</option>
        <option value="100">100</option>
        <option value="all">All</option>
      </select>
      <button onclick="fetchRides()">Refresh Table</button>
      <button onclick="clearDatabase()">Clear Table</button>
      <button onclick="exportCSV()">Export Table</button>
    </div>
    <table id="ridesTable" border="1" style="margin-top: 1em;">
      <thead>
        <tr>
          <th>Ride #</th>
          <th>Line</th>
          <th>Boarding Stop</th>
          <th>Departing Stop</th>
          <th>Date</th>
          <th>Transferred</th>
          <th>Delete?</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  <div id="paginationControls" style="margin-top: 1em;"></div>

  <script>
    const backendUrl = `https://subway-tracker-production.up.railway.app`;

    const lineSelect = document.getElementById("line");
    const boardStopSelect = document.getElementById("boardStop");
    const departStopSelect = document.getElementById("departStop");
    const messageDiv = document.getElementById("message");
    const ridesTableBody = document.querySelector("#ridesTable tbody");

    let allRides = [];
    let currentPage = 1;
    let entriesPerPage = 25;

    window.addEventListener("DOMContentLoaded", () => {
      const lines = Object.keys(stopsByLine).sort();
      lines.forEach(line => {
        const opt = document.createElement("option");
        opt.value = line;
        opt.textContent = line;
        lineSelect.appendChild(opt);
      });

      fetchRides();
    });

    lineSelect.addEventListener("change", () => {
      const line = lineSelect.value;
      const stops = stopsByLine[line] || [];

      [boardStopSelect, departStopSelect].forEach(select => {
        select.innerHTML = "<option value=''>Select stop</option>";
        stops.forEach(stop => {
          const opt = document.createElement("option");
          opt.value = stop;
          opt.textContent = stop;
          select.appendChild(opt);
        });
      });
    });

    async function submitRide() {
      const submitBtn = document.getElementById("submitButton");
      submitBtn.disabled = true;
      submitBtn.textContent = "Submitting...";

      const line = lineSelect.value;
      const boardStop = boardStopSelect.value;
      const departStop = departStopSelect.value;
      const rideDateInput = document.getElementById("rideDate").value;
      const transferred = document.getElementById("transferred").checked;

      if (!line || !boardStop || !departStop || !rideDateInput) {
        alert("Please fill in all fields.");
        submitBtn.disabled = false;
        submitBtn.textContent = "Submit Ride";
        return;
      }

      const data = {
        line,
        board_stop: boardStop,
        depart_stop: departStop,
        date: rideDateInput,
        transferred
      };

      try {
        const res = await fetch(`${backendUrl}/rides/`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(data)
        });

        const result = await res.json();

        if (res.ok) {
          messageDiv.textContent = "New ride successfully recorded!";
          await fetchRides();  // wait for table update before enabling
        } else {
          messageDiv.textContent = `Error ${res.status}: ${result.detail || 'Unknown error'}`;
        }
      } catch (err) {
        console.error(err);
        messageDiv.textContent = `Error submitting ride: ${err.message}`;
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = "Submit Ride";
      }
    }

  
    async function fetchRides() {
      const loadingIndicator = document.getElementById("loading");
      loadingIndicator.style.display = "block";
      try {
        const res = await fetch(`${backendUrl}/rides/`);
        if (!res.ok) throw new Error("Failed to fetch rides");
        const data = await res.json();
        allRides = data.sort((a, b) => new Date(b.date) - new Date(a.date));
      } catch (err) {
        allRides = [];
        console.warn("No rides found or error occurred:", err);
      } finally {
        loadingIndicator.style.display = "none";
        renderTable();
      }
    }

  
    function changeEntriesPerPage() {
      const value = document.getElementById("entriesPerPage").value;
      entriesPerPage = value === "all" ? allRides.length : parseInt(value);
      currentPage = 1;
      renderTable();
    }
  
    function renderTable() {
      const tableBody = document.querySelector("#ridesTable tbody");
      tableBody.innerHTML = "";
  
      const start = (currentPage - 1) * entriesPerPage;
      const end = start + entriesPerPage;
      const paginatedRides = allRides.slice(start, end);
  
      paginatedRides.forEach(ride => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${ride.ride_number}</td>
          <td>${ride.line}</td>
          <td>${ride.board_stop}</td>
          <td>${ride.depart_stop}</td>
          <td>${ride.date}</td>
          <td>${ride.transferred ? "Yes" : "No"}</td>
          <td>
            <button 
              data-id="${ride.id}"
              data-ride-number="${ride.ride_number}"
              onclick="deleteRide(this)" 
              title="Delete ride" 
              style="background:none;border:none;cursor:pointer;"
            >üóëÔ∏è</button>
          </td>`;

        tableBody.appendChild(row);
      });
  
      renderPaginationControls();
    }
  
    function renderPaginationControls() {
      const totalPages = Math.ceil(allRides.length / entriesPerPage);
      const container = document.getElementById("paginationControls");
      container.innerHTML = "";

      if (totalPages <= 1) return;

      const makeButton = (label, onClick, disabled = false) => {
        const btn = document.createElement("button");
        btn.textContent = label;
        btn.style.margin = "0 4px";
        btn.disabled = disabled;
        btn.onclick = onClick;
        return btn;
      };

      container.appendChild(makeButton("‚èÆ First", () => {
        currentPage = 1;
        renderTable();
      }, currentPage === 1));

      container.appendChild(makeButton("‚óÄ Prev", () => {
        currentPage--;
        renderTable();
      }, currentPage === 1));

      const pageDisplay = document.createElement("span");
      pageDisplay.textContent = ` Page ${currentPage} of ${totalPages} `;
      pageDisplay.style.margin = "0 8px";
      container.appendChild(pageDisplay);

      container.appendChild(makeButton("Next ‚ñ∂", () => {
        currentPage++;
        renderTable();
      }, currentPage === totalPages));

      container.appendChild(makeButton("Last ‚è≠", () => {
        currentPage = totalPages;
        renderTable();
      }, currentPage === totalPages));
    }



  
    async function clearDatabase() {
      if (confirm("Are you sure you want to delete all rides?")) {
        try {
          const res = await fetch(`${backendUrl}/rides/`, { method: "DELETE" });
          if (res.ok) {
            await fetchRides();
            alert("Cleared all rides from table.");
          } else {
            alert("Failed to clear rides.");
          }
        } catch (err) {
          console.error("Error clearing DB:", err);
          alert("Error clearing rides.");
        }
      }
    }

  
    function exportCSV() {
      window.location.href = "https://subway-tracker-production.up.railway.app/rides/export";
    }
  </script>
</body>
</html>
